<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google OAuth - Redirecting...</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            text-align: center;
            padding: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status { margin-top: 20px; font-size: 18px; }
        .error { color: #ff6b6b; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Google OAuth</h1>
        <div class="spinner"></div>
        <div class="status" id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google...</div>
    </div>

    <script>
        // –ù–ê–°–¢–†–û–ô–ö–ò - –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ò!
        const CONFIG = {
            CLIENT_ID: '340752343067-79ipapn7o97qd8ibqvgpjg4687fm7jo7.apps.googleusercontent.com',
            REDIRECT_URI: window.location.origin + window.location.pathname, // URL —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            N8N_WEBHOOK_URL: 'https://guglovskij.app.n8n.cloud/webhook/google-oauth-callback', // n8n webhook –¥–ª—è callback
            BACKEND_URL: 'http://5.83.140.54:8089', // —Ç–≤–æ–π backend
            SCOPES: [
                'openid',
                'profile',
                'email',
                'https://www.googleapis.com/auth/drive.readonly'
            ]
        };

        const statusEl = document.getElementById('status');

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus(message, isError = false) {
            statusEl.textContent = message;
            if (isError) {
                statusEl.classList.add('error');
            }
            console.log(message);
        }

        // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const state = urlParams.get('state');
        const error = urlParams.get('error');

        // –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∞ –æ—Ç Google
        if (error) {
            updateStatus('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + error, true);
            setTimeout(() => {
                window.location.href = CONFIG.BACKEND_URL + '/?error=' + encodeURIComponent(error);
            }, 3000);
        }
        // –ï—Å–ª–∏ –µ—Å—Ç—å code - —ç—Ç–æ callback –æ—Ç Google
        else if (code) {
            updateStatus('‚úÖ –ö–æ–¥ –ø–æ–ª—É—á–µ–Ω, –æ–±–º–µ–Ω–∏–≤–∞–µ–º –Ω–∞ —Ç–æ–∫–µ–Ω...');
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥ –≤ n8n webhook
            fetch(CONFIG.N8N_WEBHOOK_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    code: code,
                    state: state,
                    redirect_uri: CONFIG.REDIRECT_URI
                })
            })
            .then(response => response.json())
            .then(data => {
                updateStatus('‚úÖ –£—Å–ø–µ—à–Ω–æ! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...');
                
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ backend —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const redirectUrl = `${CONFIG.BACKEND_URL}/api/auth/google/callback?` +
                    `token=${encodeURIComponent(data.access_token || '')}&` +
                    `email=${encodeURIComponent(data.email || '')}&` +
                    `name=${encodeURIComponent(data.name || '')}`;
                
                window.location.href = redirectUrl;
            })
            .catch(err => {
                console.error('Error:', err);
                updateStatus('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–º–µ–Ω–µ –∫–æ–¥–∞: ' + err.message, true);
                setTimeout(() => {
                    window.location.href = CONFIG.BACKEND_URL + '/?error=oauth_exchange_failed';
                }, 3000);
            });
        }
        // –ï—Å–ª–∏ –Ω–µ—Ç code - —ç—Ç–æ –Ω–∞—á–∞–ª–æ OAuth flow
        else {
            updateStatus('üîÑ –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ Google...');
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º state –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            const state = Math.random().toString(36).substring(7);
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è Google OAuth
            const googleAuthUrl = new URL('https://accounts.google.com/o/oauth2/v2/auth');
            googleAuthUrl.searchParams.append('client_id', CONFIG.CLIENT_ID);
            googleAuthUrl.searchParams.append('redirect_uri', CONFIG.REDIRECT_URI);
            googleAuthUrl.searchParams.append('response_type', 'code');
            googleAuthUrl.searchParams.append('scope', CONFIG.SCOPES.join(' '));
            googleAuthUrl.searchParams.append('access_type', 'offline');
            googleAuthUrl.searchParams.append('prompt', 'consent');
            googleAuthUrl.searchParams.append('state', state);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º state –≤ sessionStorage –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            sessionStorage.setItem('oauth_state', state);
            
            // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ Google
            setTimeout(() => {
                window.location.href = googleAuthUrl.toString();
            }, 500);
        }
    </script>
</body>
</html>

